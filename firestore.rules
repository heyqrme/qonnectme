/**
 * @file Firestore Security Rules
 * @description This ruleset enforces a strict user-ownership model for personal data,
 *              public read access for store items and profile themes, and admin-restricted
 *              write access for store items and profile themes.
 *
 * Data Structure:
 * - /users/{userId}: User profiles, secured by owner-only access.
 * - /users/{userId}/profiles/{profileId}: User sub-profiles, secured by owner-only access.
 * - /users/{userId}/photos/{photoId}: User photos, secured by owner-only access.
 * - /users/{userId}/videos/{videoId}: User videos, secured by owner-only access.
 * - /users/{userId}/music/{musicId}: User music, secured by owner-only access.
 * - /friend_requests/{friendRequestId}: Friend requests, with sender/receiver-based access.
 * - /store_items/{storeItemId}: Store items, publicly readable, admin-writable.
 * - /profile_themes/{profileThemeId}: Profile themes, publicly readable, admin-writable.
 * - /roles_admin/{userId}: Admin role assignments.
 *
 * Key Security Decisions:
 * - User data is strictly private and only accessible by the owning user.
 * - Store items and profile themes are publicly readable to enable broad discovery.
 * - Only users listed in `/roles_admin/{userId}` can create or modify store items and profile themes.
 * - Listing of user documents is disallowed as a security best practice.
 * - Uses structural segregation by grouping user-owned data under `/users/{userId}`.
 *
 * Denormalization for Authorization:
 * - To keep the rules simple and fast, avoid using `get()` calls.  Instead, rely on
 *   path-based authorization and the `request.auth.uid` variable.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Checks if the request is made by an authenticated user.
     * @return {bool} True if the user is signed in, false otherwise.
     */
    function isSignedIn() {
      return request.auth != null;
    }

    /**
     * @description Checks if the request is made by the owner of the resource.
     * @param {string} userId - The user ID to compare with the request's authentication UID.
     * @return {bool} True if the user is the owner, false otherwise.
     */
    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    /**
     * @description Checks if the request is made by the owner of the resource and that the resource exists.
     * @param {string} userId - The user ID to compare with the request's authentication UID.
     * @return {bool} True if the user is the owner and the resource exists, false otherwise.
     */
    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }

    /**
     * @description Checks if the requesting user has admin privileges.
     * @return {bool} True if the user is an admin, false otherwise.
     */
    function isAdmin() {
      return exists(/databases/$(database)/documents/roles_admin/$(request.auth.uid));
    }

    /**
     * @description Rules for the /users/{userId} collection.
     * @path /users/{userId}
     * @allow (create) User with UID 'user123' creates a profile with id 'user123'.
     * @deny (create) User with UID 'user123' tries to create a profile with id 'user456'.
     * @principle Enforces document ownership for writes.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId) && request.resource.data.id == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.id == resource.data.id;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/profiles/{profileId} collection.
     * @path /users/{userId}/profiles/{profileId}
     * @allow (create) User with UID 'user123' creates a profile with id 'profile456' under /users/user123.
     * @deny (create) User with UID 'user123' tries to create a profile under /users/user456.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/profiles/{profileId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/photos/{photoId} collection.
     * @path /users/{userId}/photos/{photoId}
     * @allow (create) User with UID 'user123' creates a photo with id 'photo789' under /users/user123.
     * @deny (create) User with UID 'user123' tries to create a photo under /users/user456.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/photos/{photoId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/videos/{videoId} collection.
     * @path /users/{userId}/videos/{videoId}
     * @allow (create) User with UID 'user123' creates a video with id 'video101' under /users/user123.
     * @deny (create) User with UID 'user123' tries to create a video under /users/user456.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/videos/{videoId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /users/{userId}/music/{musicId} collection.
     * @path /users/{userId}/music/{musicId}
     * @allow (create) User with UID 'user123' creates music with id 'music202' under /users/user123.
     * @deny (create) User with UID 'user123' tries to create music under /users/user456.
     * @principle Restricts access to a user's own data tree.
     */
    match /users/{userId}/music/{musicId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Rules for the /friend_requests/{friendRequestId} collection.
     * @path /friend_requests/{friendRequestId}
     * @allow (create) User with UID 'user123' creates a friend request with senderId 'user123'.
     * @deny (create) User with UID 'user123' tries to create a friend request with senderId 'user456'.
     * @principle Enforces that users can only create friend requests where they are the sender or receiver, or update requests where they are the receiver.
     */
    match /friend_requests/{friendRequestId} {
      allow get: if isSignedIn() && (resource.data.senderId == request.auth.uid || resource.data.receiverId == request.auth.uid);
      allow list: if isSignedIn();
      allow create: if isSignedIn() && (request.resource.data.senderId == request.auth.uid || request.resource.data.receiverId == request.auth.uid);
      allow update: if isSignedIn() && resource.data.receiverId == request.auth.uid;
      allow delete: if false;
    }

    /**
     * @description Rules for the /store_items/{storeItemId} collection.
     * @path /store_items/{storeItemId}
     * @allow (get, list) Anyone can read store items.
     * @allow (create, update, delete) Only admins can modify store items.
     * @principle Publicly readable, admin-writable.
     */
    match /store_items/{storeItemId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /profile_themes/{profileThemeId} collection.
     * @path /profile_themes/{profileThemeId}
     * @allow (get, list) Anyone can read profile themes.
     * @allow (create, update, delete) Only admins can modify profile themes.
     * @principle Publicly readable, admin-writable.
     */
    match /profile_themes/{profileThemeId} {
      allow get: if true;
      allow list: if true;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }

    /**
     * @description Rules for the /roles_admin/{userId} collection.
     * @path /roles_admin/{userId}
     * @allow (get, create, update, delete) Only admins can manage admin roles.
     * @principle Existence-based admin privileges.
     */
    match /roles_admin/{userId} {
      allow get: if isAdmin();
      allow list: if false;
      allow create: if isAdmin();
      allow update: if isAdmin() && resource != null;
      allow delete: if isAdmin() && resource != null;
    }
  }
}
